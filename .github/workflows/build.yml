name: Build
on:
  push:
    branches:
      - develop
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  reset-test-db:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install psql dependency
        run: sudo apt-get update && sudo apt-get -y install postgresql-client

      - name: Reset Tests DB
        env:
          PGHOST: ${{ secrets.PG_DB_HOSTURL }}
          PGPORT: ${{ secrets.PG_DB_PORT }}
          PGUSER: ${{ secrets.PG_DB_USERNAME }}
          PGPASSWORD: ${{ secrets.PG_DB_PASSWORD }}
        run: |
          echo "Dropping database 'remote_test_db'..."
          psql -c "DROP DATABASE IF EXISTS remote_test_db;"
          echo "Creating database 'remote_test_db'..."
          psql -c "CREATE DATABASE remote_test_db;"
          echo "Done."

  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    needs: reset-test-db
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Use Node.js 16.x
        uses: actions/setup-node@v3
        with:
          node-version: '16.x'
      - run: |
          npm install
          npm run test:ci
        env:
          PG_DB_HOSTURL: ${{ secrets.PG_DB_HOSTURL }}
          PG_DB_PORT: ${{ secrets.PG_DB_PORT }}
          PG_DB_USERNAME: ${{ secrets.PG_DB_USERNAME }}
          PG_DB_PASSWORD: ${{ secrets.PG_DB_PASSWORD }}
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}